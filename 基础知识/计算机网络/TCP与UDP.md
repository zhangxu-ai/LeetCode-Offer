# TCP与UDP

## 概述

||TCP|UDP|
|-|-|-|
|连接|先建立连接再发数据|直接发|
|可靠|可靠|相较而言不可靠|
|速度|较慢|较快|
|数据|字节流,头部20个字节|报文,头部8个字节|
|场景|文件，电邮，终端接入，HTTP|DNS(默认),简单文件传输，视频直播，语言通话|

## TCP可靠的保障方法

1. 应用数据被**分割**成 TCP 认为最适合发送的数据块。
2. TCP 给发送的每一个包进行编号，接收方对数据包进行排序，把**有序数据**传送给应用层。
3. **校验和**： TCP 将保持它首部和数据的检验和。这是一个端到端的检验和，目的是检测数据在传输过程中的任何变化。如果收到段的检验和有差错，TCP 将丢弃这个报文段和不确认收到此报文段。
4. TCP 的接收端会**丢弃重复**的数据。
5. 流量控制： 控制发送方发送速率，保证接收方来得及接收。TCP 连接的每一方都有固定大小的缓冲空间，TCP的接收端只允许发送端发送接收端缓冲区能接纳的数据。当接收方来不及处理发送方的数据，能提示发送方降低发送的速率，防止包丢失。TCP 使用的流量控制协议是可变大小的滑动窗口协议。 （TCP 利用**滑动窗口实现流量控制**）
6. **拥塞控制**： 当网络拥塞时，减少数据的发送。
   1. 在某段时间，若对网络中某一资源的需求超过了该资源所能提供的可用部分，网络的**性能就要变坏**
   2. 是一个**全局性**的过程，涉及到所有的主机，所有的路由器，以及与降低网络传输性能有关的所有因素
   3. 为了进行拥塞控制，TCP 发送方要维持一个 拥塞窗口(**cwnd**) 的状态变量。拥塞控制窗口的大小取决于网络的拥塞程度，并且动态变化。发送方让自己的发送窗口取为拥塞窗口和接收方的接受窗口中**较小**的一个。
   4. 慢开始：cwnd开始小，然后**逐轮加倍**(1,2,4,8)
   5. 拥塞避免:拥塞避免算法的思路是让拥塞窗口cwnd缓慢增大，即**每经过一个往返时间RTT就把发送放的cwnd加1**.
   6. 快重传：
    在 TCP/IP 中，快速重传和恢复（fast retransmit and recovery，**FRR**）是一种拥塞控制算法，它能快速恢复丢失的数据包。没有 FRR，如果数据包丢失了，TCP 将会使用定时器来要求传输暂停。在暂停的这段时间内，没有新的或复制的数据包被发送。有了 FRR，如果接收机接收到一个不按顺序的数据段，它会立即给发送机发送一个重复确认。如果发送机**接收到三个重复确认**，它会假定确认件指出的数据段丢失了，并**立即重传**这些丢失的数据段。有了 FRR，就不会因为重传时要求的暂停被耽误。 　当有单独的数据包丢失时，快速重传和恢复（FRR）能最有效地工作。当有多个数据信息包在某一段很短的时间内丢失时，它则不能很有效地工作。
   7. 快恢复：cwnd不是从1重新开始。

7. **ARQ协议**： 也是为了实现可靠传输的，它的基本原理就是每发完一个分组就停止发送，等待对方确认。在收到确认后再发下一个分组。
8. **超时重传**： 当 TCP 发出一个段后，它启动一个定时器，等待目的端确认收到这个报文段。如果不能及时收到一个确认，将重发这个报文段。

## TCP滑动窗口

1. 发送窗口
![fsck](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost2/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP-%E5%8F%AF%E9%9D%A0%E7%89%B9%E6%80%A7/16.jpg)

   * #1 是已发送并收到 ACK确认的数据：1~31 字节
   * #2 是已发送但未收到 ACK确认的数据：32~45 字节
   * #3 是未发送但总大小在接收方处理范围内（接收方还有空间）：46~51字节
   * #4 是未发送但总大小超过接收方处理范围（接收方没有空间）：52字节以后

2. 接收窗口
![jsck](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost2/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP-%E5%8F%AF%E9%9D%A0%E7%89%B9%E6%80%A7/20.jpg)
   * #1 + #2 是已成功接收并确认的数据（等待应用进程读取）；
   * #3 是未收到数据但可以接收的数据；
   * #4 未收到数据并不可以接收的数据；
